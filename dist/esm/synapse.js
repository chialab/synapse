var re=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var se=(i,r)=>()=>(i&&(r=i(i=0)),r);var ve=(i,r)=>{for(var e in r)re(i,e,{get:r[e],enumerable:!0})};var w=(i,r,e,t)=>{for(var s=t>1?void 0:t?xe(r,e):r,n=i.length-1,o;n>=0;n--)(o=i[n])&&(s=(t?o(r,e,s):o(s))||s);return t&&s&&re(r,e,s),s};var ie=(i,r,e)=>{if(!r.has(i))throw TypeError("Cannot "+e)};var h=(i,r,e)=>(ie(i,r,"read from private field"),e?e.call(i):r.get(i)),v=(i,r,e)=>{if(r.has(i))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(i):r.set(i,e)},S=(i,r,e,t)=>(ie(i,r,"write to private field"),t?t.call(i,e):r.set(i,e),e);var a=se(()=>{});var ce={};ve(ce,{default:()=>Ne});var Ne,fe=se(()=>{a();Ne={}});a();export*from"@chialab/dna";a();function Y(i){return i.replace(/^\/*/,"")}function Se(i){return i.replace(/\/*$/,"")}function N(i){return Y(Se(i))}var P,M=class{constructor(r){v(this,P,void 0);S(this,P,new URL(`/${N(r)}`,"http://local"))}get pathname(){return h(this,P).pathname}get hash(){return h(this,P).hash}get search(){return h(this,P).search}get searchParams(){return new URLSearchParams(h(this,P).searchParams)}get href(){return`${this.pathname}${this.search}${this.hash}`}};P=new WeakMap;a();var E=class{constructor(r,e,t){this.params={};r=typeof r=="string"?new URL(r):r,this.url=r,this.path=e?.path??new M(`${r.pathname}${r.search}${r.hash}`),this.method=e?.method?.toLowerCase()||"get",this.data=e?.data,this.parent=t}get resolving(){return!this.response&&!this.error}get resolved(){return!!this.response||!!this.error}get childRequest(){return this._childRequest}get response(){return this._response}get matcher(){return this._matcher}get error(){return this._error}child(r,e){return this._childRequest=new E(r,e,this)}setMatcher(r){this._matcher=r}setParams(r){this.params=r}resolve(r){this._response=r}reject(r){this._error=r}isSubRouteRequest(r){let e=this.matcher;return!e||!e.router?!1:!!e.matches(r.url.pathname)}};a();var x=class{get childResponse(){return this._childResponse}get title(){return this._childResponse?.title??this._title}set title(r){this.setTitle(r)}get meta(){return this._childResponse?.meta??this._meta}set meta(r){this.setMeta(r)}constructor(r,e){this.request=r,e&&(this.parent=e,this.setData(e.getData()))}child(r){return this._childResponse=r}setView(r){this.view=r}getData(r=null){return this.data??r}setData(r){this.data=r}setTitle(r){this._title=r,this._childResponse&&this._childResponse.setTitle(r)}setMeta(r){this._meta=r,this._childResponse&&this._childResponse.setMeta(r)}render(){return this.view?.(this.request,this)}redirect(r,e){this.redirected=r,this.redirectInit=e}};a();a();var $=class{constructor(r){this.cache={};this.pattern=r.pattern||"*",this.priority=typeof r.priority<"u"?r.priority:20;let[e,t]=this.constructor.patternToRegex(this.pattern);this.regex=e,this.names=t}static patternToRegex(r){if(r==="*")return[/.*/,[]];let e=[],t=r.split("/").map(n=>{if(!n)return"";if(n==="*")return e.push("_"),"(\\/.*?)?";if(n.indexOf(":")!==0)return`\\/${n.replace(/([()[\]{}\\\-+.*?^$])/g,"\\$1")}`;let o=n.substr(1),l="\\/([^\\/]+?)";return o.endsWith("*")&&(o=o.substr(0,o.length-1),l="(\\/.*?)?"),e.push(o),l}).join("");return[new RegExp(`^${t||"\\/"}(#|$)`,"i"),e]}matches(r){if(r=r.split("?")[0],this.cache[r])return this.cache[r];let e=r.match(this.regex);if(!e)return this.cache[r]=!1,!1;let t={};return this.names.forEach((s,n)=>{t[s]=e[n+1]}),this.cache[r]=t,t}};var _=class extends ${constructor(e){super(e);this.handler=e.handler||(()=>{}),this.view=e.render,this.router=e.router}async exec(e,t,s,n){let o=await this.handler?.(e,t,s,n);if(o instanceof x){if(o!==t)return o}else if(o)return t.redirect(o),t;return this.router&&t.child(await this.router.navigate(e.params?._||"/",{method:e.method,data:e.data},{},!1,!1,e,t)),t}};a();var q=class extends ${constructor(e){super(e);this.before=e.before,this.after=e.after}hookBefore(e,t,s,n){return this.before?.(e,t,s,n)}hookAfter(e,t,s,n){return this.after?.(e,t,s,n)}};a();a();var L,C=class{constructor(){v(this,L,{})}on(r,e){(h(this,L)[r]=h(this,L)[r]||[]).push(e)}off(r,e){let t=h(this,L)[r];if(!t)return;let s=t.indexOf(e);s!==-1&&t.splice(s,1)}trigger(r,e){let t=h(this,L)[r];if(!!t)return t.reduce((s,n)=>n(e,s)??s,null)}};L=new WeakMap;function oe(i){return i&&typeof i=="object"&&typeof i.historyId=="string"&&typeof i.index=="number"}var ne=0,T=class extends C{constructor(){super();this._entries=[];this._map=new Map;this._index=-1;this._id=`${Date.now()}-${ne++}`}get states(){return this._entries.map(e=>this._map.get(e))}get state(){return this.states[this._index]??void 0}get index(){return this._index}get length(){return this._entries.length}reset(){this._id=`${Date.now()}-${ne++}`,this._entries.splice(0,this._entries.length),this._index=-1}async go(e){if(e===0)return;let t=this._index+e;if(t<0||t>=this._entries.length)return;let s=this.state;this._index=t,this.trigger("popstate",{state:this.state,previous:s})}async back(){return this.go(-1)}async forward(){return this.go(1)}async pushState(e){let t={historyId:this._id,url:e.url,path:e.path,title:e.title,data:e.data,index:this.index+1,type:"push"};this._map.set(t,e),this._entries=this._entries.slice(0,this._index+1),this._entries.push(t);let s=this.state;return this._index=t.index,this.trigger("pushstate",{state:this.state,previous:s}),t}async replaceState(e){let t={historyId:this._id,url:e.url,path:e.path,title:e.title,data:e.data,index:Math.max(this.index,0),type:"replace"},s=this.state;return this._index=t.index,this._map.set(t,e),this._entries[this._index]=t,this.trigger("replacestate",{state:this.state,previous:s}),t}compareStates(e,t){let s=this.states;return s.indexOf(t)<s.indexOf(e)?"back":"forward"}};a();import{window as Q}from"@chialab/dna";var X=!1;function ae(i){return JSON.parse(JSON.stringify(i))}var k,b,F=class extends T{constructor(e=Q.history){super();v(this,k,void 0);v(this,b,void 0);this.onPopState=async e=>{if(!oe(e.state))return;let t=this.state;e.state.historyId!==this._id?(this.reset(),this.trigger("popstate",{state:e.state,previous:t})):(this._index=e.state.index,this.trigger("popstate",{state:this.state,previous:t})),h(this,b)&&h(this,b).resolve(),S(this,b,void 0)};S(this,k,e),this.listen()}listen(){if(X)throw new Error('You cannot initialize more than one "BrowserHistory".');X=!0,Q.addEventListener("popstate",this.onPopState)}unlisten(){X=!1,Q.removeEventListener("popstate",this.onPopState)}async go(e){return h(this,b)&&h(this,b).reject(),new Promise((t,s)=>{S(this,b,{resolve:t,reject:s}),h(this,k).go(e)})}async pushState(e){let t=await super.pushState(e);return h(this,k).pushState(ae(t),t.title,t.url),t}async replaceState(e){let t=await super.replaceState(e);return h(this,k).replaceState(ae(t),t.title,t.url),t}};k=new WeakMap,b=new WeakMap;a();import{window as I}from"@chialab/dna";a();import{jsx as z,jsxs as Ee}from"@chialab/dna/jsx-runtime";function Me(i){if(!!i.stack)return z("p",{children:i.stack.split(/^(.*)$/gm).map(r=>z("div",{children:r}))})}function Z(i,r){let e=new x(i);return e.setTitle(r.message),e.setView(()=>z("div",{children:Ee("details",{children:[z("summary",{style:"color: red",children:r.message}),Me(r)]})})),e}var ue="http://local",A,D,K,O,V=class extends C{constructor(e={},t=[],s=[]){super();this.errorHandler=Z;this.connectedRoutes=[];this.connectedMiddlewares=[];v(this,A,void 0);v(this,D,void 0);v(this,K,I.location.origin!=="null"?I.location.origin:"http://local");v(this,O,"/");this.onPopState=({state:e,previous:t})=>{e?this.replace(e.path,void 0,e.data,!1).then(()=>{this.trigger("popstate",{state:this.state,previous:t})}):this.trigger("popstate",{state:e,previous:t})};e.origin&&this.setOrigin(e.origin),e.base&&this.setBase(e.base),e.errorHandler&&this.setErrorHandler(e.errorHandler),t&&t.forEach(n=>this.connect(n)),s&&s.forEach(n=>this.middleware(n))}get origin(){return h(this,K)}get base(){return h(this,O)}get started(){return!!this.history}get state(){if(!!this.history)return this.history.state}get current(){return this.state?.path}setOrigin(e){if(this.history)throw new Error("Cannot set origin after router is started.");S(this,K,N(e))}setBase(e){if(this.started)throw new Error("Cannot set base after router is started.");S(this,O,e.indexOf("#")!==-1?`/${N(e)}`:`/${N(e.split("?")[0])}`)}setErrorHandler(e){this.errorHandler=e??Z}async handle(e,t,s=null){let n=this.connectedRoutes,o=this.connectedMiddlewares,l=this.pathFromUrl(e.url.href),u=new x(e,t);u.setData(s);for(let p=o.length-1;p>=0;p--){let d=o[p],g=d.matches(l);if(!!g){try{u=await d.hookBefore(e,u,g,this)||u}catch(m){throw e.reject(m),m}if(u.redirected!=null)return e.resolve(u),u}}let c=n.reduceRight((p,d)=>async(g,m)=>{if(m.redirected!=null)return m;let U=d.matches(l);if(U===!1)return p(g,m,this);g.setMatcher(d),g.setParams(U);let y=await d.exec(g,m,p,this)??m;return y.redirected?y:(m=y,d.view&&m.setView(d.view),m)},()=>{throw new Error("Not found")});try{u=await c(e,u,this)??u}catch(p){throw e.reject(p),p}if(u.redirected!=null)return e.resolve(u),u;for(let p=o.length-1;p>=0;p--){let d=o[p],g=d.matches(l);if(!!g){try{u=await d.hookAfter(e,u,g,this)||u}catch(m){throw e.reject(m),m}if(u.redirected!=null)return e.resolve(u),u}}return e.resolve(u),u}async navigate(e,t,s=null,n=!0,o=!1,l,u){return this.setCurrentNavigation(async()=>{e=typeof e=="string"?new M(e):e,t={...t,path:e};let c=this.urlFromPath(e);if(!this.shouldNavigate(c)&&!o)return this.fragment(c.hash||""),null;let p=l?l.child(c,t):new E(c,t);this.setCurrentRequest(p);let d;try{d=await this.handle(p,u)}catch(m){d=this.handleError(p,m)}if(p!==h(this,D))throw new Error("Request aborted.");let g=d.title||I.document.title;return await this.pushState({url:d.redirected||c.href,path:e.href,title:g,request:p,response:d,data:d.getData()},n),d.redirected!=null?this.replace(d.redirected,d.redirectInit,s,n,l,u):d})}async replace(e,t,s=null,n=!0,o,l){return this.setCurrentNavigation(async()=>{e=typeof e=="string"?new M(e):e,t={...t,path:e};let u=this.urlFromPath(e),c=o?o.child(u,t):new E(u,t);this.setCurrentRequest(c);let p;try{p=await this.handle(c,l,s)}catch(g){p=this.handleError(c,g)}if(c!==h(this,D))throw new Error("Request aborted.");let d=p.title||I.document.title;return await this.replaceState({url:p.redirected||u.href,path:e.href,title:d,request:c,response:p,data:p.getData()},n),p.redirected!=null?this.replace(p.redirected,p.redirectInit,s,n):p})}refresh(e){return this.replace(e||this.current||"/")}fragment(e){this.history instanceof F&&I.location.hash!==e&&(I.location.hash=e)}middleware(e,t,s){let n;return e instanceof q?n=e:typeof e=="string"?n=new q({pattern:e,before:s,after:t}):n=new q(e),this.connectedMiddlewares.push(n),this.connectedMiddlewares.sort((o,l)=>l.priority-o.priority),n}connect(e,t){let s;if(e instanceof _)s=e;else if(typeof e=="string"){if(!t)throw new Error(`Missing handler for "${e}" route`);s=new _({pattern:e,handler:t})}else s=new _(e);return this.connectedRoutes.push(s),this.connectedRoutes.sort((n,o)=>o.priority-n.priority),s}disconnect(e){if(e instanceof _){let t=this.connectedRoutes.indexOf(e);if(t!==-1)return this.connectedRoutes.splice(t,1),!0}else if(e instanceof q){let t=this.connectedMiddlewares.indexOf(e);if(t!==-1)return this.connectedMiddlewares.splice(t,1),!0}return!1}async start(e,t){return this.history=e,this.history.reset(),e.on("popstate",this.onPopState),e instanceof F?this.replace(t||this.pathFromUrl(I.location.href)||"/"):this.replace(t||"/")}end(){this.history&&(this.history.off("popstate",this.onPopState),this.history=void 0)}resolve(e,t=!1){let s=this.urlFromPath(e);return t?s.href:`${s.pathname}${s.search}${s.hash}`}pathFromUrl(e){let t=typeof e=="string"?new URL(e,this.origin):e;if(t.origin!==this.origin)return null;let s=`/${Y(t.pathname)}${t.search}${t.hash}`;if(s!==this.base&&s.indexOf(this.base)!==0)return null;let n=new M(s.replace(this.base,""));return`${n.pathname}${n.search}`}urlFromPath(e){return new URL(`/${[this.base,typeof e=="string"?e:e.href].map(t=>N(t)).filter(t=>!!t).join("/")}`,this.origin)}waitNavigation(){return h(this,A)}setCurrentNavigation(e){return S(this,A,e())}setCurrentRequest(e){return S(this,D,e)}handleError(e,t){e.reject(t);let s=this.errorHandler(e,t,this);if(!(s instanceof x)){let n=s;s=new x(e),s.setTitle(t.message),s.setView(n)}return s}async pushState(e,t=!0){let s=this.state;this.history&&await this.history.pushState(e),t&&await this.trigger("pushstate",{state:e,previous:s})}async replaceState(e,t=!0){let s=this.state;this.history&&await this.history.replaceState(e),t&&await this.trigger("replacestate",{previous:s,state:e})}shouldNavigate(e){return this.state?e instanceof M?this.state.path!==e.href:this.state.url!==e.href:!0}};A=new WeakMap,D=new WeakMap,K=new WeakMap,O=new WeakMap;a();import{Component as qe,window as B,property as j,state as be,observe as G,listen as de,customElementPrototype as Pe}from"@chialab/dna";a();var pe=function({response:r}){return r?.render()};import{jsx as _e}from"@chialab/dna/jsx-runtime";var R=class extends qe{constructor(){super(...arguments);this.autostart=!1;this.navigationDirection="forward";this.history=new T;this.router=new V({origin:this.origin,base:this.base});this.routes=[];this.middlewares=[];this._onPopState=e=>{!e.state||(this.request=e.state.request,this.onPopState(e),this.response=e.state.response)}}get origin(){return this.getInnerPropertyValue("origin")?this.getInnerPropertyValue("origin"):B.location.origin&&B.location.origin!=="null"?B.location.origin:ue}set origin(e){this.setInnerPropertyValue("origin",e)}get base(){return this.getInnerPropertyValue("base")||"/"}set base(e){this.setInnerPropertyValue("base",e)}connectedCallback(){super.connectedCallback(),this.autostart&&this.start(typeof this.autostart=="string"?this.autostart:void 0)}render(){return this.response?_e(pe,{response:this.response}):null}async start(e){let{router:t,history:s,routes:n,middlewares:o}=this;n.forEach(u=>{t.connect(u)}),o.forEach(u=>{t.middleware(u)}),t.middleware({pattern:"*",priority:-1/0,before:u=>{this.request=u}}),t.on("popstate",this._onPopState),t.on("pushstate",this._onPopState),t.on("replacestate",this._onPopState);let l=await t.start(s,e);if(l)return this.response=l,l}navigate(e,t){return this.router.navigate(e,t)}replace(e,t){return this.router.replace(e,t)}_handleLink(e,t){if(!!this.router.started)return this.handleLink(e,t)}_handleSubmit(e,t){if(!!this.router.started)return this.handleSubmit(e,t)}async handleLink(e,t){let s=t.getAttribute("href");if(!s||(t.getAttribute("target")||"_self")!=="_self")return;let o=this.router.pathFromUrl(s);!o||(e.preventDefault(),e.stopPropagation(),this.navigate(o))}async handleSubmit(e,t){let s=t.getAttribute("action");if(!s||(t.getAttribute("target")||"_self")!=="_self")return;let o=this.router.pathFromUrl(s);if(!o)return;let l=t.getAttribute("method")?.toLowerCase(),u=new B.FormData(t);if(e.preventDefault(),e.stopPropagation(),l==="get"){let c=new URLSearchParams(u);this.navigate(`${o.split("?")[0]}?${c}`)}else this.navigate(o,{method:l,data:u})}onPopState(e){let{state:t,previous:s}=e;t&&s?this.navigationDirection=this.history.compareStates(s,t):this.navigationDirection="forward"}_onRequestChanged(e,t){this.onRequest(e,t)}_onResponseChanged(e,t){this.onResponse(e,t)}_onOriginChanged(){this.router&&this.router.setOrigin(this.origin)}_onBaseChanged(){if(this.router){let e=this.base;e[0]==="#"&&(e=`${B.location.pathname}${B.location.search}${e}`),this.router.setBase(e)}}onRequest(e,t){}onResponse(e,t){}};w([j({type:String})],R.prototype,"origin",1),w([j({type:String})],R.prototype,"base",1),w([j({type:E})],R.prototype,"request",2),w([j({type:x})],R.prototype,"response",2),w([j({type:[Boolean,String]})],R.prototype,"autostart",2),w([be({type:String,attribute:":navigation",update:!1})],R.prototype,"navigationDirection",2),w([de("click","a")],R.prototype,"_handleLink",1),w([de("submit","form")],R.prototype,"_handleSubmit",1),w([G("request")],R.prototype,"_onRequestChanged",1),w([G("response")],R.prototype,"_onResponseChanged",1),w([G("origin")],R.prototype,"_onOriginChanged",1),w([G("base")],R.prototype,"_onBaseChanged",1),R=w([Pe],R);a();import{window as He,Node as Le}from"@chialab/dna";import{Fragment as ke,jsx as ee,jsxs as Ie}from"@chialab/dna/jsx-runtime";var Te=function({children:r}){return r},zt=function({router:r,children:e,renderer:t=Te},s){if(!r)throw new Error("Transition router is required");let{start:n,store:o,requestUpdate:l}=s;if(!n)return ee(t,{children:e},r.state);let u=o.get("state"),c=n.parentElement,p=o.get("previousState"),d=o.get("previousChildren");if(u!==r.state){if(c){let g=function(y){if(y.target.parentNode!==c)return;let H=(o.get("counter")||0)+1;o.set("counter",H)},m=function(y){if(y.target.parentNode!==c)return;let H=(o.get("counter")||0)-1;o.set("counter",H),H===0&&U()},U=function(){c.removeEventListener("animationstart",g),c.removeEventListener("animationend",m),o.delete("previousState"),o.delete("previousChildren"),l?.()};c.addEventListener("animationstart",g),c.addEventListener("animationend",m),setTimeout(()=>{let y=s.start;for(;y&&y!==s.end;)if(y=y.nextSibling,y.nodeType===Le.ELEMENT_NODE){let H=He.getComputedStyle(y),ye=H.getPropertyValue("animation-name"),we=H.getPropertyValue("animation-duration");if(ye!=="none"&&we!=="0s")return}U()})}p=u,d=o.get("children"),o.set("previousState",p),o.set("previousChildren",d),o.set("counter",0),o.set("children",e),o.set("state",r.state)}return Ie(ke,{children:[p&&ee(t,{children:d},p),ee(t,{children:e},r.state)]})};a();function le(i){return i instanceof R?i:i.parentNode?le(i.parentNode):null}function Qt(i){return le(i)?.router??null}a();import{window as he}from"@chialab/dna";function tr(){return typeof he._jsdom>"u"}function rr(){return typeof he._jsdom<"u"}a();import{window as me}from"@chialab/dna";async function ar(i,r){if(typeof me.fetch=="function")return me.fetch(i,r);try{let{default:e}=await Promise.resolve().then(()=>(fe(),ce));return e(i,r)}catch{}throw new Error("Missing fetch implementation")}a();import{window as J}from"@chialab/dna";function lr(i){return typeof J.requestAnimationFrame=="function"?J.requestAnimationFrame(i):setTimeout(()=>i(Date.now()),0)}function hr(i){return typeof J.cancelAnimationFrame=="function"?J.cancelAnimationFrame(i):clearTimeout(i)}a();import{DOM as $e,window as Ce}from"@chialab/dna";var Re=new Map;function Rr(i,r=!1){let e=typeof i=="string"?i:i.href,t=Re.get(e);if(!t||r){let s=$e.createElement("script");s.src=e,t=new Promise((n,o)=>{s.addEventListener("load",()=>n()),s.addEventListener("error",()=>o()),s.addEventListener("abort",()=>o()),Ce.document.head.appendChild(s)}),Re.set(e,t)}return t}a();import{DOM as Fe,window as ge}from"@chialab/dna";var W=new Map;function xr(i,r=!1){let e=typeof i=="string"?i:i.href,t=W.get(e),s;if(!t||r){let n=Fe.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=e,s=new Promise((o,l)=>{n.addEventListener("load",()=>n.parentNode?o(n):l(n)),n.addEventListener("error",()=>l(n)),n.addEventListener("abort",()=>l(n)),ge.document.head.appendChild(n)}),W.set(e,[n,s])}else s=t[1];return s}function vr(i){let r=typeof i=="string"?i:i.href,e=W.get(r);if(!e)return;let t=e[0];ge.document.head.removeChild(t),W.delete(r)}a();import{document as De}from"@chialab/dna";var te=class extends q{constructor(e=De,t,s){super({});this.currentMeta={};this.document=e,this.titleBuilder=t||(n=>n||""),this.metaBuilder=s||(n=>n||{})}hookAfter(e,t){return this.setTitle(this.titleBuilder(t.title,t)),this.setMeta(this.metaBuilder(t.meta,t)),t}setTitle(e){this.document!==void 0&&(this.document.title=e)}setMeta(e){if(this.document===void 0)return;let t=this.document.head;Object.entries(e).forEach(([s,n])=>{let o=t.querySelector(`meta[name="${s}"]`);if(o!==null){o.setAttribute("content",n);return}o=t.ownerDocument.createElement("meta"),o.setAttribute("name",s),o.setAttribute("content",n),t.appendChild(o)}),Object.keys(this.currentMeta).filter(s=>!(s in e)).forEach(s=>{let n=t.querySelector(`meta[name="${s}"]`);n!==null&&n.remove()})}};export{R as App,F as BrowserHistory,te as DocumentMetaMiddleware,T as History,q as Middleware,pe as Page,M as Path,E as Request,x as Response,_ as Route,V as Router,zt as Transition,hr as cancelAnimationFrame,ar as fetch,le as getApp,Qt as getRouter,tr as isBrowser,rr as isNode,Rr as loadScript,xr as loadStyleSheet,lr as requestAnimationFrame,vr as unloadStyleSheet};
//# sourceMappingURL=synapse.js.map
