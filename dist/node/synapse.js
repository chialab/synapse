var fe=Object.defineProperty;var me=Object.getOwnPropertyDescriptor;var g=(n,r,e,t)=>{for(var s=t>1?void 0:t?me(r,e):r,i=n.length-1,o;i>=0;i--)(o=n[i])&&(s=(t?o(r,e,s):o(s))||s);return t&&s&&fe(r,e,s),s};var ee=(n,r,e)=>{if(!r.has(n))throw TypeError("Cannot "+e)};var l=(n,r,e)=>(ee(n,r,"read from private field"),e?e.call(n):r.get(n)),w=(n,r,e)=>{if(r.has(n))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(n):r.set(n,e)},x=(n,r,e,t)=>(ee(n,r,"write to private field"),t?t.call(n,e):r.set(n,e),e);export*from"@chialab/dna";function J(n){return n.replace(/^\/*/,"")}function Re(n){return n.replace(/\/*$/,"")}function k(n){return J(Re(n))}var q,v=class{constructor(r){w(this,q,void 0);x(this,q,new URL(`/${k(r)}`,"http://local"))}get pathname(){return l(this,q).pathname}get hash(){return l(this,q).hash}get search(){return l(this,q).search}get searchParams(){return new URLSearchParams(l(this,q).searchParams)}get href(){return`${this.pathname}${this.search}${this.hash}`}};q=new WeakMap;var S=class{constructor(r,e,t){this.params={};r=typeof r=="string"?new URL(r):r,this.url=r,this.path=e?.path??new v(`${r.pathname}${r.search}${r.hash}`),this.method=e?.method?.toLowerCase()||"get",this.data=e?.data,this.parent=t}get resolving(){return!this.response&&!this.error}get resolved(){return!!this.response||!!this.error}get childRequest(){return this._childRequest}get response(){return this._response}get matcher(){return this._matcher}get error(){return this._error}child(r,e){return this._childRequest=new S(r,e,this)}setMatcher(r){this._matcher=r}setParams(r){this.params=r}resolve(r){this._response=r}reject(r){this._error=r}isSubRouteRequest(r){let e=this.matcher;return!e||!e.router?!1:!!e.matches(r.url.pathname)}};var y=class{get childResponse(){return this._childResponse}get title(){return this._childResponse?.title??this._title}set title(r){this.setTitle(r)}get meta(){return this._childResponse?.meta??this._meta}set meta(r){this.setMeta(r)}constructor(r,e){this.request=r,e&&(this.parent=e,this.setData(e.getData()))}child(r){return this._childResponse=r}setView(r){this.view=r}getData(r=null){return this.data??r}setData(r){this.data=r}setTitle(r){this._title=r,this._childResponse&&this._childResponse.setTitle(r)}setMeta(r){this._meta=r,this._childResponse&&this._childResponse.setMeta(r)}render(){return this.view?.(this.request,this)}redirect(r,e){this.redirected=r,this.redirectInit=e}};var I=class{constructor(r){this.cache={};this.pattern=r.pattern||"*",this.priority=typeof r.priority<"u"?r.priority:20;let[e,t]=this.constructor.patternToRegex(this.pattern);this.regex=e,this.names=t}static patternToRegex(r){if(r==="*")return[/.*/,[]];let e=[],t=r.split("/").map(i=>{if(!i)return"";if(i==="*")return e.push("_"),"(\\/.*?)?";if(i.indexOf(":")!==0)return`\\/${i.replace(/([()[\]{}\\\-+.*?^$])/g,"\\$1")}`;let o=i.substr(1),d="\\/([^\\/]+?)";return o.endsWith("*")&&(o=o.substr(0,o.length-1),d="(\\/.*?)?"),e.push(o),d}).join("");return[new RegExp(`^${t||"\\/"}(#|$)`,"i"),e]}matches(r){if(r=r.split("?")[0],this.cache[r])return this.cache[r];let e=r.match(this.regex);if(!e)return this.cache[r]=!1,!1;let t={};return this.names.forEach((s,i)=>{t[s]=e[i+1]}),this.cache[r]=t,t}};var b=class extends I{constructor(e){super(e);this.handler=e.handler||(()=>{}),this.view=e.render,this.router=e.router}async exec(e,t,s,i){let o=await this.handler?.(e,t,s,i);if(o instanceof y){if(o!==t)return o}else if(o)return t.redirect(o),t;return this.router&&t.child(await this.router.navigate(e.params?._||"/",{method:e.method,data:e.data},{},!1,!1,e,t)),t}};var M=class extends I{constructor(e){super(e);this.before=e.before,this.after=e.after}hookBefore(e,t,s,i){return this.before?.(e,t,s,i)}hookAfter(e,t,s,i){return this.after?.(e,t,s,i)}};var _,N=class{constructor(){w(this,_,{})}on(r,e){(l(this,_)[r]=l(this,_)[r]||[]).push(e)}off(r,e){let t=l(this,_)[r];if(!t)return;let s=t.indexOf(e);s!==-1&&t.splice(s,1)}trigger(r,e){let t=l(this,_)[r];if(!!t)return t.reduce((s,i)=>i(e,s)??s,null)}};_=new WeakMap;function re(n){return n&&typeof n=="object"&&typeof n.historyId=="string"&&typeof n.index=="number"}var te=0,H=class extends N{constructor(){super();this._entries=[];this._map=new Map;this._index=-1;this._id=`${Date.now()}-${te++}`}get states(){return this._entries.map(e=>this._map.get(e))}get state(){return this.states[this._index]??void 0}get index(){return this._index}get length(){return this._entries.length}reset(){this._id=`${Date.now()}-${te++}`,this._entries.splice(0,this._entries.length),this._index=-1}async go(e){if(e===0)return;let t=this._index+e;if(t<0||t>=this._entries.length)return;let s=this.state;this._index=t,this.trigger("popstate",{state:this.state,previous:s})}async back(){return this.go(-1)}async forward(){return this.go(1)}async pushState(e){let t={historyId:this._id,url:e.url,path:e.path,title:e.title,data:e.data,index:this.index+1,type:"push"};this._map.set(t,e),this._entries=this._entries.slice(0,this._index+1),this._entries.push(t);let s=this.state;return this._index=t.index,this.trigger("pushstate",{state:this.state,previous:s}),t}async replaceState(e){let t={historyId:this._id,url:e.url,path:e.path,title:e.title,data:e.data,index:Math.max(this.index,0),type:"replace"},s=this.state;return this._index=t.index,this._map.set(t,e),this._entries[this._index]=t,this.trigger("replacestate",{state:this.state,previous:s}),t}compareStates(e,t){let s=this.states;return s.indexOf(t)<s.indexOf(e)?"back":"forward"}};import{window as W}from"@chialab/dna";var Y=!1;function se(n){return JSON.parse(JSON.stringify(n))}var L,E,$=class extends H{constructor(e=W.history){super();w(this,L,void 0);w(this,E,void 0);this.onPopState=async e=>{if(!re(e.state))return;let t=this.state;e.state.historyId!==this._id?(this.reset(),this.trigger("popstate",{state:e.state,previous:t})):(this._index=e.state.index,this.trigger("popstate",{state:this.state,previous:t})),l(this,E)&&l(this,E).resolve(),x(this,E,void 0)};x(this,L,e),this.listen()}listen(){if(Y)throw new Error('You cannot initialize more than one "BrowserHistory".');Y=!0,W.addEventListener("popstate",this.onPopState)}unlisten(){Y=!1,W.removeEventListener("popstate",this.onPopState)}async go(e){return l(this,E)&&l(this,E).reject(),new Promise((t,s)=>{x(this,E,{resolve:t,reject:s}),l(this,L).go(e)})}async pushState(e){let t=await super.pushState(e);return l(this,L).pushState(se(t),t.title,t.url),t}async replaceState(e){let t=await super.replaceState(e);return l(this,L).replaceState(se(t),t.title,t.url),t}};L=new WeakMap,E=new WeakMap;import{window as T}from"@chialab/dna";import{jsx as O,jsxs as ye}from"@chialab/dna/jsx-runtime";function ge(n){if(!!n.stack)return O("p",{children:n.stack.split(/^(.*)$/gm).map(r=>O("div",{children:r}))})}function Q(n,r){let e=new y(n);return e.setTitle(r.message),e.setView(()=>O("div",{children:ye("details",{children:[O("summary",{style:"color: red",children:r.message}),ge(r)]})})),e}var ie="http://local",U,C,V,A,B=class extends N{constructor(e={},t=[],s=[]){super();this.errorHandler=Q;this.connectedRoutes=[];this.connectedMiddlewares=[];w(this,U,void 0);w(this,C,void 0);w(this,V,T.location.origin!=="null"?T.location.origin:"http://local");w(this,A,"/");this.onPopState=({state:e,previous:t})=>{e?this.replace(e.path,void 0,e.data,!1).then(()=>{this.trigger("popstate",{state:this.state,previous:t})}):this.trigger("popstate",{state:e,previous:t})};e.origin&&this.setOrigin(e.origin),e.base&&this.setBase(e.base),e.errorHandler&&this.setErrorHandler(e.errorHandler),t&&t.forEach(i=>this.connect(i)),s&&s.forEach(i=>this.middleware(i))}get origin(){return l(this,V)}get base(){return l(this,A)}get started(){return!!this.history}get state(){if(!!this.history)return this.history.state}get current(){return this.state?.path}setOrigin(e){if(this.history)throw new Error("Cannot set origin after router is started.");x(this,V,k(e))}setBase(e){if(this.started)throw new Error("Cannot set base after router is started.");x(this,A,e.indexOf("#")!==-1?`/${k(e)}`:`/${k(e.split("?")[0])}`)}setErrorHandler(e){this.errorHandler=e??Q}async handle(e,t,s=null){let i=this.connectedRoutes,o=this.connectedMiddlewares,d=this.pathFromUrl(e.url.href),a=new y(e,t);a.setData(s);for(let u=o.length-1;u>=0;u--){let p=o[u],m=p.matches(d);if(!!m){try{a=await p.hookBefore(e,a,m,this)||a}catch(c){throw e.reject(c),c}if(a.redirected!=null)return e.resolve(a),a}}let h=i.reduceRight((u,p)=>async(m,c)=>{if(c.redirected!=null)return c;let D=p.matches(d);if(D===!1)return u(m,c,this);m.setMatcher(p),m.setParams(D);let R=await p.exec(m,c,u,this)??c;return R.redirected?R:(c=R,p.view&&c.setView(p.view),c)},()=>{throw new Error("Not found")});try{a=await h(e,a,this)??a}catch(u){throw e.reject(u),u}if(a.redirected!=null)return e.resolve(a),a;for(let u=o.length-1;u>=0;u--){let p=o[u],m=p.matches(d);if(!!m){try{a=await p.hookAfter(e,a,m,this)||a}catch(c){throw e.reject(c),c}if(a.redirected!=null)return e.resolve(a),a}}return e.resolve(a),a}async navigate(e,t,s=null,i=!0,o=!1,d,a){return this.setCurrentNavigation(async()=>{e=typeof e=="string"?new v(e):e,t={...t,path:e};let h=this.urlFromPath(e);if(!this.shouldNavigate(h)&&!o)return this.fragment(h.hash||""),null;let u=d?d.child(h,t):new S(h,t);this.setCurrentRequest(u);let p;try{p=await this.handle(u,a)}catch(c){p=this.handleError(u,c)}if(u!==l(this,C))throw new Error("Request aborted.");let m=p.title||T.document.title;return await this.pushState({url:p.redirected||h.href,path:e.href,title:m,request:u,response:p,data:p.getData()},i),p.redirected!=null?this.replace(p.redirected,p.redirectInit,s,i,d,a):p})}async replace(e,t,s=null,i=!0,o,d){return this.setCurrentNavigation(async()=>{e=typeof e=="string"?new v(e):e,t={...t,path:e};let a=this.urlFromPath(e),h=o?o.child(a,t):new S(a,t);this.setCurrentRequest(h);let u;try{u=await this.handle(h,d,s)}catch(m){u=this.handleError(h,m)}if(h!==l(this,C))throw new Error("Request aborted.");let p=u.title||T.document.title;return await this.replaceState({url:u.redirected||a.href,path:e.href,title:p,request:h,response:u,data:u.getData()},i),u.redirected!=null?this.replace(u.redirected,u.redirectInit,s,i):u})}refresh(e){return this.replace(e||this.current||"/")}fragment(e){this.history instanceof $&&T.location.hash!==e&&(T.location.hash=e)}middleware(e,t,s){let i;return e instanceof M?i=e:typeof e=="string"?i=new M({pattern:e,before:s,after:t}):i=new M(e),this.connectedMiddlewares.push(i),this.connectedMiddlewares.sort((o,d)=>d.priority-o.priority),i}connect(e,t){let s;if(e instanceof b)s=e;else if(typeof e=="string"){if(!t)throw new Error(`Missing handler for "${e}" route`);s=new b({pattern:e,handler:t})}else s=new b(e);return this.connectedRoutes.push(s),this.connectedRoutes.sort((i,o)=>o.priority-i.priority),s}disconnect(e){if(e instanceof b){let t=this.connectedRoutes.indexOf(e);if(t!==-1)return this.connectedRoutes.splice(t,1),!0}else if(e instanceof M){let t=this.connectedMiddlewares.indexOf(e);if(t!==-1)return this.connectedMiddlewares.splice(t,1),!0}return!1}async start(e,t){return this.history=e,this.history.reset(),e.on("popstate",this.onPopState),e instanceof $?this.replace(t||this.pathFromUrl(T.location.href)||"/"):this.replace(t||"/")}end(){this.history&&(this.history.off("popstate",this.onPopState),this.history=void 0)}resolve(e,t=!1){let s=this.urlFromPath(e);return t?s.href:`${s.pathname}${s.search}${s.hash}`}pathFromUrl(e){let t=typeof e=="string"?new URL(e,this.origin):e;if(t.origin!==this.origin)return null;let s=`/${J(t.pathname)}${t.search}${t.hash}`;if(s!==this.base&&s.indexOf(this.base)!==0)return null;let i=new v(s.replace(this.base,""));return`${i.pathname}${i.search}`}urlFromPath(e){return new URL(`/${[this.base,typeof e=="string"?e:e.href].map(t=>k(t)).filter(t=>!!t).join("/")}`,this.origin)}waitNavigation(){return l(this,U)}setCurrentNavigation(e){return x(this,U,e())}setCurrentRequest(e){return x(this,C,e)}handleError(e,t){e.reject(t);let s=this.errorHandler(e,t,this);if(!(s instanceof y)){let i=s;s=new y(e),s.setTitle(t.message),s.setView(i)}return s}async pushState(e,t=!0){let s=this.state;this.history&&await this.history.pushState(e),t&&await this.trigger("pushstate",{state:e,previous:s})}async replaceState(e,t=!0){let s=this.state;this.history&&await this.history.replaceState(e),t&&await this.trigger("replacestate",{previous:s,state:e})}shouldNavigate(e){return this.state?e instanceof v?this.state.path!==e.href:this.state.url!==e.href:!0}};U=new WeakMap,C=new WeakMap,V=new WeakMap,A=new WeakMap;import{Component as we,window as F,property as K,state as xe,observe as j,listen as oe,customElementPrototype as ve}from"@chialab/dna";var ne=function({response:r}){return r?.render()};import{jsx as Se}from"@chialab/dna/jsx-runtime";var f=class extends we{constructor(){super(...arguments);this.autostart=!1;this.navigationDirection="forward";this.history=new H;this.router=new B({origin:this.origin,base:this.base});this.routes=[];this.middlewares=[];this._onPopState=e=>{!e.state||(this.request=e.state.request,this.onPopState(e),this.response=e.state.response)}}get origin(){return this.getInnerPropertyValue("origin")?this.getInnerPropertyValue("origin"):F.location.origin&&F.location.origin!=="null"?F.location.origin:ie}set origin(e){this.setInnerPropertyValue("origin",e)}get base(){return this.getInnerPropertyValue("base")||"/"}set base(e){this.setInnerPropertyValue("base",e)}connectedCallback(){super.connectedCallback(),this.autostart&&this.start(typeof this.autostart=="string"?this.autostart:void 0)}render(){return this.response?Se(ne,{response:this.response}):null}async start(e){let{router:t,history:s,routes:i,middlewares:o}=this;i.forEach(a=>{t.connect(a)}),o.forEach(a=>{t.middleware(a)}),t.middleware({pattern:"*",priority:-1/0,before:a=>{this.request=a}}),t.on("popstate",this._onPopState),t.on("pushstate",this._onPopState),t.on("replacestate",this._onPopState);let d=await t.start(s,e);if(d)return this.response=d,d}navigate(e,t){return this.router.navigate(e,t)}replace(e,t){return this.router.replace(e,t)}_handleLink(e,t){if(!!this.router.started)return this.handleLink(e,t)}_handleSubmit(e,t){if(!!this.router.started)return this.handleSubmit(e,t)}async handleLink(e,t){let s=t.getAttribute("href");if(!s||(t.getAttribute("target")||"_self")!=="_self")return;let o=this.router.pathFromUrl(s);!o||(e.preventDefault(),e.stopPropagation(),this.navigate(o))}async handleSubmit(e,t){let s=t.getAttribute("action");if(!s||(t.getAttribute("target")||"_self")!=="_self")return;let o=this.router.pathFromUrl(s);if(!o)return;let d=t.getAttribute("method")?.toLowerCase(),a=new F.FormData(t);if(e.preventDefault(),e.stopPropagation(),d==="get"){let h=new URLSearchParams(a);this.navigate(`${o.split("?")[0]}?${h}`)}else this.navigate(o,{method:d,data:a})}onPopState(e){let{state:t,previous:s}=e;t&&s?this.navigationDirection=this.history.compareStates(s,t):this.navigationDirection="forward"}_onRequestChanged(e,t){this.onRequest(e,t)}_onResponseChanged(e,t){this.onResponse(e,t)}_onOriginChanged(){this.router&&this.router.setOrigin(this.origin)}_onBaseChanged(){if(this.router){let e=this.base;e[0]==="#"&&(e=`${F.location.pathname}${F.location.search}${e}`),this.router.setBase(e)}}onRequest(e,t){}onResponse(e,t){}};g([K({type:String})],f.prototype,"origin",1),g([K({type:String})],f.prototype,"base",1),g([K({type:S})],f.prototype,"request",2),g([K({type:y})],f.prototype,"response",2),g([K({type:[Boolean,String]})],f.prototype,"autostart",2),g([xe({type:String,attribute:":navigation",update:!1})],f.prototype,"navigationDirection",2),g([oe("click","a")],f.prototype,"_handleLink",1),g([oe("submit","form")],f.prototype,"_handleSubmit",1),g([j("request")],f.prototype,"_onRequestChanged",1),g([j("response")],f.prototype,"_onResponseChanged",1),g([j("origin")],f.prototype,"_onOriginChanged",1),g([j("base")],f.prototype,"_onBaseChanged",1),f=g([ve],f);import{window as Me,Node as Ee}from"@chialab/dna";import{Fragment as be,jsx as X,jsxs as Pe}from"@chialab/dna/jsx-runtime";var qe=function({children:r}){return r},Et=function({router:r,children:e,renderer:t=qe},s){if(!r)throw new Error("Transition router is required");let{start:i,store:o,requestUpdate:d}=s;if(!i)return X(t,{children:e},r.state);let a=o.get("state"),h=i.parentElement,u=o.get("previousState"),p=o.get("previousChildren");if(a!==r.state){if(h){let m=function(R){if(R.target.parentNode!==h)return;let P=(o.get("counter")||0)+1;o.set("counter",P)},c=function(R){if(R.target.parentNode!==h)return;let P=(o.get("counter")||0)-1;o.set("counter",P),P===0&&D()},D=function(){h.removeEventListener("animationstart",m),h.removeEventListener("animationend",c),o.delete("previousState"),o.delete("previousChildren"),d?.()};h.addEventListener("animationstart",m),h.addEventListener("animationend",c),setTimeout(()=>{let R=s.start;for(;R&&R!==s.end;)if(R=R.nextSibling,R.nodeType===Ee.ELEMENT_NODE){let P=Me.getComputedStyle(R),he=P.getPropertyValue("animation-name"),ce=P.getPropertyValue("animation-duration");if(he!=="none"&&ce!=="0s")return}D()})}u=a,p=o.get("children"),o.set("previousState",u),o.set("previousChildren",p),o.set("counter",0),o.set("children",e),o.set("state",r.state)}return Pe(be,{children:[u&&X(t,{children:p},u),X(t,{children:e},r.state)]})};function ae(n){return n instanceof f?n:n.parentNode?ae(n.parentNode):null}function _t(n){return ae(n)?.router??null}import{window as ue}from"@chialab/dna";function Tt(){return typeof ue._jsdom>"u"}function kt(){return typeof ue._jsdom<"u"}import{window as pe}from"@chialab/dna";async function $t(n,r){if(typeof pe.fetch=="function")return pe.fetch(n,r);try{let{default:e}=await import("node-fetch");return e(n,r)}catch{}throw new Error("Missing fetch implementation")}import{window as z}from"@chialab/dna";function Dt(n){return typeof z.requestAnimationFrame=="function"?z.requestAnimationFrame(n):setTimeout(()=>n(Date.now()),0)}function Bt(n){return typeof z.cancelAnimationFrame=="function"?z.cancelAnimationFrame(n):clearTimeout(n)}import{DOM as _e,window as He}from"@chialab/dna";var de=new Map;function At(n,r=!1){let e=typeof n=="string"?n:n.href,t=de.get(e);if(!t||r){let s=_e.createElement("script");s.src=e,t=new Promise((i,o)=>{s.addEventListener("load",()=>i()),s.addEventListener("error",()=>o()),s.addEventListener("abort",()=>o()),He.document.head.appendChild(s)}),de.set(e,t)}return t}import{DOM as Le,window as le}from"@chialab/dna";var G=new Map;function jt(n,r=!1){let e=typeof n=="string"?n:n.href,t=G.get(e),s;if(!t||r){let i=Le.createElement("link");i.type="text/css",i.rel="stylesheet",i.href=e,s=new Promise((o,d)=>{i.addEventListener("load",()=>i.parentNode?o(i):d(i)),i.addEventListener("error",()=>d(i)),i.addEventListener("abort",()=>d(i)),le.document.head.appendChild(i)}),G.set(e,[i,s])}else s=t[1];return s}function zt(n){let r=typeof n=="string"?n:n.href,e=G.get(r);if(!e)return;let t=e[0];le.document.head.removeChild(t),G.delete(r)}import{document as Te}from"@chialab/dna";var Z=class extends M{constructor(e=Te,t,s){super({});this.currentMeta={};this.document=e,this.titleBuilder=t||(i=>i||""),this.metaBuilder=s||(i=>i||{})}hookAfter(e,t){return this.setTitle(this.titleBuilder(t.title,t)),this.setMeta(this.metaBuilder(t.meta,t)),t}setTitle(e){this.document!==void 0&&(this.document.title=e)}setMeta(e){if(this.document===void 0)return;let t=this.document.head;Object.entries(e).forEach(([s,i])=>{let o=t.querySelector(`meta[name="${s}"]`);if(o!==null){o.setAttribute("content",i);return}o=t.ownerDocument.createElement("meta"),o.setAttribute("name",s),o.setAttribute("content",i),t.appendChild(o)}),Object.keys(this.currentMeta).filter(s=>!(s in e)).forEach(s=>{let i=t.querySelector(`meta[name="${s}"]`);i!==null&&i.remove()})}};export{f as App,$ as BrowserHistory,Z as DocumentMetaMiddleware,H as History,M as Middleware,ne as Page,v as Path,S as Request,y as Response,b as Route,B as Router,Et as Transition,Bt as cancelAnimationFrame,$t as fetch,ae as getApp,_t as getRouter,Tt as isBrowser,kt as isNode,At as loadScript,jt as loadStyleSheet,Dt as requestAnimationFrame,zt as unloadStyleSheet};
//# sourceMappingURL=synapse.js.map
